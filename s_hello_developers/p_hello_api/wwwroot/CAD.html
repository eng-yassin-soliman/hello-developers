<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>ArabiCAD</title>

    <!--External Style Sheet Files-->
    <link rel="stylesheet" type="text/css" href="_s_reset.css" />
    <link rel="stylesheet" type="text/css" href="_s_cad.css" />
    <!--Internal Style Sheet-->
    <style>
        ._item
        {
            display:inline-block;
            margin:20px 20px 0px 0px;
            padding:10px;
            border:solid 1px silver
        }

        ._name
        {
            width:300px;
        }

        ._color
        {
            width:40px;
        }
    </style>

    <!--External Script File-->
    <script src="_j_cad.js"></script>

    <!--Internal Script-->
    <script>
        // Script that runs when page full yloaded
        function v_loaded_()
        {
            // Generate random rectangle
            // Parameters of rectangle: x, y, width, height
            var l_xcr_ = 50  + Math.floor(Math.random() * 100);
            var l_ycr_ = 100 + Math.floor(Math.random() * 100);
            var l_wdt_ = 10 + Math.floor(Math.random() * 140);
            var l_hgt_ = 10 + Math.floor(Math.random() * 140);
           
            var l_seg_ = [
                "M " + l_xcr_ + " " + l_ycr_,
                "a 50 50 0 0 1 50 -50",
                "l " + l_wdt_ + " 0",
                "a 50 50 0 0 1 50 50",
                "l 0 " + l_hgt_,
                "a 50 50 0 0 1 -50 50",
                "l " + (-1 * l_wdt_) + " 0",
                "a 50 50 0 0 1 -50 -50",
                "Z"];

            document.getElementById('b_dat_').value = l_seg_.join("\n");

            // Generate random line color
            document.getElementById('b_lin_').value = "rgba("
                + Math.floor(Math.random() * 128).toString() + "," +
                + Math.floor(Math.random() * 128).toString() + "," +
                + Math.floor(Math.random() * 128).toString() + "," +
                "1)";

            // Generate random fill color
            document.getElementById('b_fil_').value = "rgba("
                + Math.floor(Math.random() * 256).toString() + "," +
                + Math.floor(Math.random() * 256).toString() + "," +
                + Math.floor(Math.random() * 256).toString() + "," +
                "0.3)";
        }

        // A class describes single drawing
        class _c_drawing
        {
            constructor()
            {
                this.s_uid_ = 0; this.s_nam_ = ""; this.s_dat_ = ""; this.s_lin_ = ""; this.s_fil_ = "";
            }
        }

        // Post the message to server
        function v_send_(p_msg_)
        {
            v_post_(p_msg_, v_success_, v_error_);
        }

        // Handle the response is succeeded
        function v_success_(p_rsp_)
        {
            var l_drw_ = JSON.parse(p_rsp_);
            l_drw_.forEach(function (p_itm_, p_ndx_)
            {
                // Draw a single drawing for a single user
                v_drawitem_(p_itm_);

                // Add user name and colors to the list
                var l_htm_ =
                    "<div class='_item _name'>" + p_itm_.s_nam_ + "</div>" +
                    "<div class='_item _color' style='background-color:" + p_itm_.s_lin_ + "'>&nbsp;</div>" +
                    "<div class='_item _color' style='background-color:" + p_itm_.s_fil_ + "'>&nbsp;</div>" +
                    "<br />";

                document.getElementById("b_lst_").insertAdjacentHTML("beforeend", l_htm_);
            });
        }

        // Handle the response on error
        function v_error_(p_rsp_)
        {
            alert("Error: " + p_rsp_);
        }

        function v_drawitem_(p_itm_)
        {
            var l_svg_ = document.getElementById('b_svg_');
            var l_pth_ = document.createElementNS("http://www.w3.org/2000/svg", 'path');
            l_pth_.setAttribute("d", p_itm_.s_dat_);
            l_pth_.setAttribute("stroke-width", 3);
            l_pth_.setAttribute("stroke", p_itm_.s_lin_);
            l_pth_.setAttribute("fill", p_itm_.s_fil_);

            l_svg_.appendChild(l_pth_);
        }

        function v_send_()
        {
            // Clear drawing panel and players panel
            document.getElementById('b_svg_').innerHTML = '';
            document.getElementById('b_lst_').innerHTML = '';

            // Instant of drawing class
            var l_msg_ = new _c_drawing();
            l_msg_.s_uid_ = localStorage.getItem("r_uid_");            // ID from local storage
            l_msg_.s_nam_ = document.getElementById('b_nam_').value;   // Client's name
            l_msg_.s_dat_ = document.getElementById('b_dat_').value;   // Data describes the drawing
            l_msg_.s_lin_ = document.getElementById('b_lin_').value;   // Line color
            l_msg_.s_fil_ = document.getElementById('b_fil_').value;   // Fill color

            // Check if ID stored
            if (l_msg_.s_uid_ === null) {
                // Generate random ID
                l_msg_.s_uid_ = Math.floor(Math.random() * 100000000); // Random integer ID between 0 - 99999999
                localStorage.setItem("r_uid_", l_msg_.s_uid_);         // Store local storage ID
            }

            v_post_obj_("CAD/api", l_msg_, v_success_, v_error_);
        }
    </script>
</head>

<body onload="v_loaded_()">
    <table>
        <tr>
            <td>
                <svg id="b_svg_" style="width:400px;height:400px;margin:20px; border:solid 1px silver" />
                <br />

                <button class="_button" onclick="v_send_()">Draw!</button>
            </td>

            <td>
                <input id="b_nam_" type="text" value="Name"
                       style="width:400px; padding:10px; margin:20px 20px 0px 0px; border:solid 1px silver" />
                <br />

                <input id="b_lin_" type="text" value="silver"
                       style="width:185px; padding:10px; margin:20px 20px 0px 0px; border:solid 1px silver" />

                <input id="b_fil_" type="text" value="red"
                       style="width:190px; padding:10px; margin:20px 20px 0px 0px; border:solid 1px silver" />
                <br />

                <textarea id="b_dat_" class="_text" style="height:275px; margin:20px 20px 0px 0px"></textarea>
            </td>

            <td id="b_lst_"></td>
        </tr>
    </table>
</body>
</html>